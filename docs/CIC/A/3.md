## Introduction[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#introduction "Direct link to Introduction")

This unit introduces the ability of running **Core Impact** modules from a previously compromised host, which may provide access to assessing a network that is not reachable _directly_ from the Impact console.

**TIP**
The ability to run **Core Impact** modules from another host is known as _pivoting_, and it can be leveraged in other scenarios as well. For example, to perform a a remote security assessment where the user is provided access to a host on the target network. Instead of installing **Core Impact** on the host, an **OS Agent** can be deployed on the target (for example, using `ssh` if it's on another platform too) which can then be used to run the **Core Impact** modules in the session.

Then a database system on an internal back-end network is compromised, which shows the ability of **Core Impact** to interact with database systems and potentially escalate such access to running an **OS Agent** on the database host.

## Features[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#features "Direct link to Features")

- Leverage a previously compromised host to run **Core Impact** modules from that system
- Explore a compromised database system with a Network SQL Agent
- Escalate from database access to running an OS Agent on the database host
- Generate report of discovered vulnerabilities

## Highlighted Modules[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#highlighted-modules "Direct link to Highlighted Modules")

- Network Information Gathering RPT
- Network Attack and Penetration RPT
- Network Clean Up RPT
- Network Report Generation RPT
- Install PCAP Plugin
- Refresh Network Interfaces
- PostgreSQL Identity Verifier
- SQL Shell
- Install SQL Agent using credentials
- Install OS Agent using SQL Agent

## References[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#references "Direct link to References")

- Microsoft Windows SMB Pool Overflow Remote Code Execution Exploit (MS17-010)
    - Vulnerabilities: CVE-2017-0143, CVE-2017-0144, CVE-2017-0145, CVE-2017-0146, CVE-2017-0147, CVE-2017-0148
    - [Wikipedia article on EternalBlue](https://en.wikipedia.org/wiki/EternalBlue)
    - [What Is EternalBlue and Why Is the MS17-010 Exploit Still Relevant?](https://www.avast.com/c-eternalblue)
- Weak Credentials
    - [CWE-521: Weak Password Requirements](https://cwe.mitre.org/data/definitions/521.html) (from [Mitre's Common Weakness Enumeration](https://cwe.mitre.org/)).

## Walkthrough[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#walkthrough "Direct link to Walkthrough")

### Hosts[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#hosts "Direct link to Hosts")

- Microsoft Windows SMB Pool Overflow Remote Code Execution Exploit (MS17-010)
    - Hostname: `WIN-0NVC5M7BAU7`
    - IP Address: `10.27.34.43`

### Create a New Workspace[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#create-a-new-workspace "Direct link to Create a New Workspace")

Follow the [steps](https://impacttrial.coresecurity.com/docs/doc/walkthrough/basics#create-workspace) from the previous unit and create a new workspace (`demo2`).

### Network Information Gathering[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#network-information-gathering "Direct link to Network Information Gathering")

We'll now launch the **Network Information Gathering** RPT module to discover a target host and determine running services to test.

1. From the **RPT Pane**, select and click **Network Information Gathering** RPT to discover hosts on the network.

![Network IG RPT Welcome](https://impacttrial.coresecurity.com/assets/images/network_ig_welcome-353904b811f84861d26dce40505fe3b3.png)

2. Click **Next**.

![Network IG RPT Discovery Method](https://impacttrial.coresecurity.com/assets/images/network_ig_discovery_method-4a0c1d417a5d1566e74a4dc51d630d03.png)

3. Click **Next**.

![Network IG RPT IP Version](https://impacttrial.coresecurity.com/assets/images/network_ig_ip_version-aaf51928f70e9ccaefa7601656845432.png)

4. Click **Next**.

![Network IG RPT IP Range Selection](https://impacttrial.coresecurity.com/assets/images/network_ig_ip_range_selection-1f96ed7000ec8c7988ea1029f27ae0fa.png)

5. Replace the network range with the address of the target host: `10.27.34.43` and click **Next**.

![Network IG RPT Scan Type](https://impacttrial.coresecurity.com/assets/images/network_ig_scan_type-ac4f57e2cb362c917908e521c2c4d4ff.png)

6. Select **FAST** and click **Finish**.

The **Network Information Gathering** module will launch, which will discover and perform information gathering on the `WIN-0NVC5M7BAU7` (`10.27.34.43`) host.

![Network IG RPT Results](https://impacttrial.coresecurity.com/assets/images/network_ig_results-f75eaccff01bdad44e1c8c3cd7a0702b.png)

### Network Attack and Penetration With Remote Exploits[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#network-attack-and-penetration-with-remote-exploits "Direct link to Network Attack and Penetration With Remote Exploits")

We'll now launch **Network Attack and Penetration** RPT to use **Core Impact** exploits to try to detect and exploit vulnerabilities to compromise and control the target host.

1. From the **RPT Pane**, select and drag & drop the **Network Attack and Penetration** RPT module onto the `WIN-0NVC5M7BAU7` (`10.27.34.43`) host, created in the previous section.

![Network AP RPT Welcome](https://impacttrial.coresecurity.com/assets/images/network_ap_welcome-bce14edf82203f2e86ff7b5c2505625e.png)

2. Click **Next**.

![Network AP RPT Target Selection](https://impacttrial.coresecurity.com/assets/images/network_ap_target_selection-5f934b19c5bcfad74f727bf007e14d61.png)

3. Click **Next**.

**NOTE**
The `WIN-0NVC5M7BAU7` (`10.27.34.43`) host will already be selected because the module was drag & dropped on the target. If you launch **Network Attack and Penetration** by just clicking the module, in this step you can use ellipsis (`...`) button to select the module's targets.

![Network AP RPT Attack Method](https://impacttrial.coresecurity.com/assets/images/network_ap_attack_method-67ddee6f42cfad27414a9ee895054b5d.png)

4. Click **Next**.

![Network AP RPT Attack Configuration](https://impacttrial.coresecurity.com/assets/images/network_ap_attack_configuration-fedb4bd655ebe70c4ca028fd23128311.png)

5. Click **Next**.

![Network AP RPT Additional Settings](https://impacttrial.coresecurity.com/assets/images/network_ap_additional_settings-4f64b3cfa6303696f83e064bb36f7be6.png)

6. Click **Finish**.

The **Network Attack and Penetration** module will launch, and after testing available exploits for the identified OS and services, it should be able to detect and exploit the _EternalBlue_ vulnerability and deploy an **OS Agent**.

![Network AP RPT Results](https://impacttrial.coresecurity.com/assets/images/network_ap_results-6d2f840389543820de25b3d932822b4c.png)

### Installing the PCAP Plugin[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#installing-the-pcap-plugin "Direct link to Installing the PCAP Plugin")

On the deployed **OS Agent**, we'll setup the PCAP plugin, which provides the agent with additional cabilities to capture and inject network traffic on the compromised host, which allows for more reliable network information gathering methods to be executed.

1. From the list view, right-click on the deployed OS agent and select **Install pcap plugin** to survey available network interfaces and perform more reliable IG.

![Install PCAP Plugin Context Menu](https://impacttrial.coresecurity.com/assets/images/install_pcap_plugin_context_menu-b23a0bd2a091e10215cd52b275b422b1.png)

2. In the **Executed Modules** pane, open the **PCAP Plugin Install** module and select the **Refresh Network Interfaces** module.

The **Module Output** of the **Refresh Network Interfaces** shows that the host has two interfaces, on two separate networks:

- `10.27.34.0/24` (Netmask: `255.255.255.0`)
    - This is the network where the _Impact Client_ VM is also located and through which we discovered and compromised the host.
- `10.27.35.0/24` (Netmask: `255.255.255.0`)
    - This is an internal network, which is not reachable from the _Impact Client_ VM.

![Refresh Network Interfaces Results](https://impacttrial.coresecurity.com/assets/images/refresh_network_interfaces_results-f3ddabcc71779de56a74fa4c6aa9326a.png)

**NOTE**
The available _network interfaces_ on the host are stored in the **OS Agent**'s properties, and are shown in the **Quick Information** pane when selecting it.

### Perform Network Information Gathering on Unreachable Network[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#perform-network-information-gathering-on-unreachable-network "Direct link to Perform Network Information Gathering on Unreachable Network")

We'll now confirm that the second network we've just discovered is not reachable from the _Impact Client_ VM.

Execute the steps to launch [Network Information Gathering](https://impacttrial.coresecurity.com/docs/doc/walkthrough/basics#network-information-gathering) from the previous unit, but replacing the _network range_ with `10.27.35.50/29`.

After the **Network Information Gathering** RPT module is launched and completes its execution, the module will not have been able to find (and add) new hosts.

![Network IG RPT Results on 10.27.35.50/29](https://impacttrial.coresecurity.com/assets/images/network_ig_results_net_35_unreachable-19e7c865a70f397c92fe3b8e79aa5715.png)

### Perform Network Information Gathering From Compromised Host[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#perform-network-information-gathering-from-compromised-host "Direct link to Perform Network Information Gathering From Compromised Host")

Leveraging the **OS Agent** on the compromised `WIN-0NVC5M7BAU7` (`10.27.34.43`) host, we'll perform **Network Information Gathering** on the internal network.

In order to execute **Core Impact** modules from the compromised host, we'll set the `agent(0)` as the _source agent_.

1. Right-click on the `agent(0)` entity and select **Set as source**.

![Set source agent](https://impacttrial.coresecurity.com/assets/images/set_source_agent-3c1f947e8df527c2b2db02a73fa72cf9.png)

2. From the **RPT Pane**, select and click **Network Information Gathering** RPT to discover hosts on the internal network.

![Network IG RPT Welcome](https://impacttrial.coresecurity.com/assets/images/network_ig_welcome-353904b811f84861d26dce40505fe3b3.png)

3. Click **Next**.

![Network IG RPT Discovery Method](https://impacttrial.coresecurity.com/assets/images/network_ig_discovery_method_pivot-5d30588fe548d7778a0bc812e8320446.png)

4. Click **Next**.

![Network IG RPT IP Version](https://impacttrial.coresecurity.com/assets/images/network_ig_ip_version-aaf51928f70e9ccaefa7601656845432.png)

5. Click **Next**.

![Network IG RPT IP Range Selection](https://impacttrial.coresecurity.com/assets/images/network_ig_ip_range_selection_net_35-94cf440a1b548b1e4d4d84b7f4219068.png)

6. Replace the network range with the address of the internal network: `10.27.35.50/29` and click **Next**.

![Network IG RPT Interface Selection](https://impacttrial.coresecurity.com/assets/images/network_ig_ip_interface_selection-70c9edaf114f8f0f6082f0ed3fb6ab48.png)

7. Click the ellipsis (`...`) button and selec the _network interface_ with the IP address (`10.27.35.47`) on the internal network, and click **OK**.
8. Click **Next**.

![Network IG RPT Scan Type](https://impacttrial.coresecurity.com/assets/images/network_ig_scan_type-ac4f57e2cb362c917908e521c2c4d4ff.png)

7. Select **FAST** and click **Finish**.

The **Network Information Gathering** module will launch, which will discover host `10.27.35.53`. If the host is selected, it can be seen that the host is running a PostgreSQL database's service.

![Network IG RPT Results](https://impacttrial.coresecurity.com/assets/images/network_ig_results_net_35-d9d59412e914ecbc98b5e98ccb52ead7.png)

**NOTE**
Notice that the **Executed Modules** pane shows in the **Source** column that the modules have run on the _agent_ previously set as source.

### Run Dictionary Attack on PostgreSQL Service to Find Weak Credentials[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#run-dictionary-attack-on-postgresql-service-to-find-weak-credentials "Direct link to Run Dictionary Attack on PostgreSQL Service to Find Weak Credentials")

We'll try to compromise the PostgreSQL service by checking if _weak credentials_ have been configured, and which can be determined by running a _dictionary attack_ using **Core Impact**'s _Identity Verifiers_.

In this scenario the administrator of the machine may have assumed that stronger credentials would not be necessary as there is no direct access from the local network into the server.

1. From the **RPT Pane**, select and drag & drop the **Network Attack and Penetration** RPT module onto the `postgresql-10-5.internal.cloudapp.net` (`10.27.35.53`) host, created in the previous section.

![Network AP RPT Welcome](https://impacttrial.coresecurity.com/assets/images/network_ap_welcome-bce14edf82203f2e86ff7b5c2505625e.png)

2. Click **Next**.

![Network AP RPT Target Selection](https://impacttrial.coresecurity.com/assets/images/network_ap_target_selection_postgresql_host-5728a4ad463807b1d84bd286ff69fce4.png)

3. Click **Next**.

![Network AP RPT Attack Method](https://impacttrial.coresecurity.com/assets/images/network_ap_attack_method_identity_verifiers-7179c2e8ed4d71cbbfa9047d7cd48b23.png)

1. Uncheck option to launch _exploits_ and check the option to launch _identity verifiers_, and click **Next**.

![Network AP RPT Attack Configuration](https://impacttrial.coresecurity.com/assets/images/network_ap_attack_configuration_identity_verifiers-0278b6465db9df1513db9d2f9c72607f.png)

5. Click **Next**.

![Network AP RPT Additional Settings](https://impacttrial.coresecurity.com/assets/images/network_ap_additional_settings_identity_verifiers-2a5d8be015926918bc4c9f27a8326c64.png)

6. Check the **Identity verifier protocol selection** option to limit the protocols on which we'll try identity verifiers, and click **Next**.

![Network AP RPT Identity Attack Selection](https://impacttrial.coresecurity.com/assets/images/network_ap_identity_attack_selection-66f7edc6b5e77c3f3c7646d8019e03eb.png)

7. Click **Uncheck All** and then check the **PostgreSQL** option.
8. Click **Finish**.

**Network Attack and Penetration** will start and after a while it'll find a weak credential, which will be used to configure a **Network SQL Agent** on the target host.

**TIP**
Notice that a **Network SQL Agent** is different from an **OS Agent**. This agent allows the user to execute SQL commands impersonating the user associated with the valid credentials found by the **Identity Verifier** module.

![Network AP RPT Results](https://impacttrial.coresecurity.com/assets/images/network_ap_results_network_sql_agent-cb96e6e16ced2f6803154cd8ceea8729.png)

### Interact With the Database Server Through the Network SQL Agent[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#interact-with-the-database-server-through-the-network-sql-agent "Direct link to Interact With the Database Server Through the Network SQL Agent")

We're now going to execute SQL queries on the compromised PostgreSQL database server, in order to obtain information about the databases on the server, and look for sensitive information.

1. Right-click on the **SQL Agent (0)** entity and select **SQL Shell**.
2. Execute the following command to list available databases:

- `select datname from pg_catalog.pg_database`

![SQL Shell - List Databases](https://impacttrial.coresecurity.com/assets/images/sql_shell_list_databases-dfe72140565c91dff9d21b70895b29d7.png)

3. Close the shell by executing the `exit` command.

Because _PostgreSQL_ doesn't provide commands to switch to another database (like the `USE DATABASE` command in _SQL Server_), we'll set up a new **Network SQL Agent** to connect to the `northwind` database.

We'll need the credentials used to deploy the previous **Network SQL Agent**, which can be seen in the _vulnerability_ configured in the host, select the available identity and see that the username is `postgres` and the password is `admin`.

![PostgreSQL Identity](https://impacttrial.coresecurity.com/assets/images/postgresql_identity-456e62da0254943494a448ee8950f8e5.png)

4. In the **Modules** pane, open the **10-Post Exploitation > Agents** folder and select the module **Install SQL Agent using credentials**.
5. Drag & drop the module onto the `postgresql-10-5.internal.cloudapp.net` (`10.27.35.53`) host.
6. Configure the module parameters:

- Database engine: `PostgreSQL`
- User: `postgres`
- Password: `admin`
- Database: `northwind`

![Install SQL Agent using credentials Module Parameters](https://impacttrial.coresecurity.com/assets/images/install_sql_agent_using_credentials_parameters-a0a74f0fc2b2728940e35b5ab6e1b286.png)

7. Click **OK**.

Another **Network SQL Agent** should now be configured, which will execute SQL statements on the specified database (`northwind`).

We'll now get information about the database by running the `Get databases schema` module.

8. In the **Modules** pane, search for the module by entering its name, and then drag & drop it in the new **Network SQL Agent**.

You can see the module's _log_ while it makes progress in retrieving the database schema executing SQL statements. When the module finishes, the database's tables are shown in the **Module Output** pane.

![Get database schema](https://impacttrial.coresecurity.com/assets/images/get_database_schema-cbde7776d14f241f7b4a8ac8639eec40.png)

We can now leverage the database schema information and retrieve the people in the `Contacts` table.

9. Right-click on the **SQL Agent (1)** entity and select **SQL Shell**.
10. Execute the command: `select "ContactName" from "Contacts"`.

![SQL Shell - Contacts](https://impacttrial.coresecurity.com/assets/images/sql_shell_contacts-a2dc61fa0db8a720a42e22c1ecf0eef3.png)

11. Close the shell.

### Escalate the Network SQL Agent and Deploy an OS Agent[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#escalate-the-network-sql-agent-and-deploy-an-os-agent "Direct link to Escalate the Network SQL Agent and Deploy an OS Agent")

If the database and credentials used to deploy the **Network SQL Agent** allow it, we can try and escalate from that agent (which allows us to execute only SQL statements) and try to deploy and **OS Agent** to have shell like features on the host.

Before we do that, we need to go to the pivot **OS Agent** we're using in `10.27.34.43` and change the host address that **Core Impact** is configured to use from that host, and choose one of the other IP address available in the host.

**NOTE**
This is required to deploy the **OS Agent** on the **PostgreSQL** host, because the module will create a process that will try to connect back to the pivot agent, and the IP address that it connects back to is configured by the current IP address on that entity. Because traffic from/to the different networks is restricted, the **PostgreSQL** host will not be able to connect back to `10.27.34.43`, but it will be able to connect to its IP address in the `10.27.35.0/24` network, `10.27.35.47`.

1. Go to host `10.27.34.43`, select the **OS Agent** configured in the host, right-click and choose the option **Select host address...**.
2. In the parameters dialog, select the ellipsis (`...`) button after selecting to edit the `ADDRESS` parameter value.
3. Select the `10.27.35.47` IP address.

![Select Host Address](https://impacttrial.coresecurity.com/assets/images/select_host_address-91284f6b216fc58189686126c81228f5.png)

4. Click **OK** to select the address.
5. Click **OK** to launch the module to change the host's address.

- The IP address of the host in the network view should have been updated to reflect the selected IP address.

We're now going to try and deploy the **OS Agent** through the **Network SQL Agent**.

6. Go to the **Modules** pane, and in the **10-Post Exploitation > Agents** folder select the module **Install OS Agent using SQL Agent**.
7. Drag-and-drop that module on the first **Network SQL Agent** (`SQL Agent(0)`) configured in the **PostgreSQL** host, which has _admin_ access and will allow for the **OS Agent** to be deployed.

An **OS Agent** should be deployed in the **PostgreSQL** host.

![Install OS Agent using SQL Agent](https://impacttrial.coresecurity.com/assets/images/install_os_agent_using_sql_agent-59e78cff1e38eda5b126b42c902fa930.png)

8. Right-click on the new **OS Agent** and launch a shell or _file browser_ to inspect the system where the database is hosted.

![Inspect PostgreSQL host - Shell](https://impacttrial.coresecurity.com/assets/images/inspect_postgresql_host_shell-058e39ddd84e4b5701d43c6bbc4bc718.png) ![Inspect PostgreSQL host - File Browser](https://impacttrial.coresecurity.com/assets/images/inspect_postgresql_host_file_browser-849e3c97fe061af93a03433fb3d28a50.png)

### Perfom Clean Up of Deployed OS Agents[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#perfom-clean-up-of-deployed-os-agents "Direct link to Perfom Clean Up of Deployed OS Agents")

We'll now clean up deployed agents on compromised hosts, using the **Clean Up** RPT step.

**TIP**
This will uninstall only **OS Agents**, which run on the target systems. **Network SQL Agents** only connect to the target system whenever a module runs (in order to perform SQL statements), and when the module completes there is no longer a connection nor process running on the system.

1. From the **RPT Pane**, select and click **Network Clean Up** RPT.

![Network Clean Up RPT Welcome](https://impacttrial.coresecurity.com/assets/images/network_cleanup_welcome-9457c59918ca22330d3724bf8620101a.png)

2. Click **Next**.

![Network Clean Up RPT Confirm](https://impacttrial.coresecurity.com/assets/images/network_cleanup_confirm-80244e2ce4290745afdfdefc64b7a0cc.png)

3. Select the option to confirm uninstallation of connected **OS Agents**.
4. Click **Finish**.

When the module completes, you'll see that the **OS Agents** in the **PostgreSQL** host and that of the Windows host used to pivot to reach that host have been uninstalled.

**NOTE**
The module determines the order of uninstallation to make sure that a _pivot agent_ is not uninstalled before an **OS Agent** reached through is uninstalled.

![Network Clean Up RPT Results](https://impacttrial.coresecurity.com/assets/images/network_cleanup_results-7ebf6ef9e6bed2b50dccb4def89541bd.png)

### Generate Vulnerability Report[​](https://impacttrial.coresecurity.com/docs/doc/walkthrough/other_network_features/#generate-vulnerability-report "Direct link to Generate Vulnerability Report")

Once again, you can generate a **Vulnerability Report** to document the vulnerabilities found in this pen testing session's _workspace_ following the steps in the previous unit's section [Generate report of vulnerabilities](https://impacttrial.coresecurity.com/docs/doc/walkthrough/basics#generate-report-of-vulnerabilities).

![Network Report Generation RPT Results](https://impacttrial.coresecurity.com/assets/images/network_report_generation_report_results-a6bc205bc811ac7f4bd3284c1334f6a8.png)